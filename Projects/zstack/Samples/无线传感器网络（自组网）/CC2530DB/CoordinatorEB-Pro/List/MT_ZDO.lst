###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.10338/W32 for 8051         04/May/2014  16:34:54 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Components\mt\MT_ZDO.c                             #
#    Command line       =  -f H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä #
#                          £©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£ #
#                          ©\CC2530DB\..\..\..\Tools\CC2530DB\f8wCoord.cfg    #
#                          (-DCPU32MHZ -DROOT=__near_func                     #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DZDO_COORDINATOR -DRTR_NWK -DBLINK_LEDS) -f       #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg      #
#                          (-DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR      #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF0                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Components\mt\MT_ZDO.c -D ZIGBEEPRO -D ZTOOL_P1    #
#                          -D NWK_AUTO_POLL -D xMT_TASK -D xMT_SYS_FUNC -D    #
#                          xMT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG -lC            #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\CoordinatorEB-Pro\List\ -lA                #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\CoordinatorEB-Pro\List\ --diag_suppress    #
#                          Pe001,Pa010 -o H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×é #
#                          ÍøÓëÊý¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷Í #
#                          øÂç£¨×Ô×éÍø£©\CC2530DB\CoordinatorEB-Pro\Obj\ -e   #
#                          --debug --core=plain --dptr=16,1                   #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä #
#                          £©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£ #
#                          ©\CC2530DB\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×é #
#                          ÍøÓëÊý¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷Í #
#                          øÂç£¨×Ô×éÍø£©\CC2530DB\..\SOURCE\ -I               #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\ZMAIN\TI2530DB\ -I                #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\..\..\COMPONENTS\MT\ -I           #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\..\..\COMPONENTS\HAL\INCLUDE\ -I  #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\..\..\COMPONENTS\HAL\TARGET\CC253 #
#                          0EB\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾ #
#                          Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô #
#                          ×éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\MCU #
#                          \CCSOC\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓë #
#                          Êý¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£ #
#                          ¨×Ô×éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\ #
#                          INCLUDE\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓ #
#                          ëÊý¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç #
#                          £¨×Ô×éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS\STAC #
#                          K\AF\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý #
#                          ¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨× #
#                          Ô×éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\N #
#                          WK\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý #
#                          ´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô× #
#                          éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SEC #
#                          \ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´« #
#                          Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍ #
#                          ø£©\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SAPI\ #
#                           -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Ê #
#                          ä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø #
#                          £©\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SYS\   #
#                          -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä #
#                          £©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£ #
#                          ©\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\ZDO\    #
#                          -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä #
#                          £©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£ #
#                          ©\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\F8W\ -I  #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\..\..\COMPONENTS\ZMAC\ -I         #
#                          H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\..\..\..\..\..\COMPONENTS\SERVICES\SADDR\  #
#                          -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä #
#                          £©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£ #
#                          ©\CC2530DB\..\..\..\..\..\COMPONENTS\SERVICES\SDAT #
#                          A\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´ #
#                          «Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×é #
#                          Íø£©\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\INCLUD #
#                          E\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´ #
#                          «Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×é #
#                          Íø£©\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\HIGH_L #
#                          EVEL\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý #
#                          ¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨× #
#                          Ô×éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW #
#                          _LEVEL\srf04\ -I H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô #
#                          ×éÍøÓëÊý¾Ý´«Êä£©\Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ #
#                          ÷ÍøÂç£¨×Ô×éÍø£©\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\LOW_LEVEL\srf04\SINGLE_CHIP\ -Ohz             #
#    List file          =  H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\CoordinatorEB-Pro\List\MT_ZDO.lst          #
#    Object file        =  H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\ #
#                          Projects\zstack\Samples\ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍø£©\C #
#                          C2530DB\CoordinatorEB-Pro\Obj\MT_ZDO.r51           #
#                                                                             #
#                                                                             #
###############################################################################

H:\zigbeesrc\8.ÎÞÏß´«¸ÐÆ÷ÍøÂç£¨×Ô×éÍøÓëÊý¾Ý´«Êä£©\Components\mt\MT_ZDO.c
      1          /**************************************************************************************************
      2            Filename:       MT_ZDO.c
      3            Revised:        $Date: 2009-12-29 11:40:43 -0800 (Tue, 29 Dec 2009) $
      4            Revision:       $Revision: 21414 $
      5          
      6            Description:    MonitorTest functions for the ZDO layer.
      7          
      8          
      9            Copyright 2004-2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          #ifdef MT_ZDO_FUNC
     41          
     42          /**************************************************************************************************
     43           * INCLUDES
     44           **************************************************************************************************/
     45          #include "ZComDef.h"
     46          #include "OSAL.h"
     47          #include "MT.h"
     48          #include "MT_ZDO.h"
     49          #include "APSMEDE.h"
     50          #include "ZDConfig.h"
     51          #include "ZDProfile.h"
     52          #include "ZDObject.h"
     53          #include "ZDApp.h"
     54          
     55          #if !defined( WIN32 )
     56            #include "OnBoard.h"
     57          #endif
     58          
     59          #if defined(ZDO_LINK_KEY_MANAGEMENT)
     60            #include "ZDSecMgr.h"
     61          #endif
     62          
     63          #include "nwk_util.h"
     64          
     65          /**************************************************************************************************
     66           * CONSTANTS
     67           **************************************************************************************************/
     68          #define MT_ZDO_END_DEVICE_ANNCE_IND_LEN   0x0D
     69          #define MT_ZDO_ADDR_RSP_LEN               0x0D
     70          #define MT_ZDO_BIND_UNBIND_RSP_LEN        0x03
     71          
     72          #define MTZDO_RESPONSE_BUFFER_LEN   100
     73          
     74          #define MTZDO_MAX_MATCH_CLUSTERS    16
     75          #define MTZDO_MAX_ED_BIND_CLUSTERS  15
     76          
     77          // Conversion from ZDO Cluster Id to the RPC AREQ Id is direct as follows:
     78          #define MT_ZDO_CID_TO_AREQ_ID(CId)  ((uint8)(CId) | 0x80)
     79          
     80          /**************************************************************************************************
     81           * GLOBAL VARIABLES
     82           **************************************************************************************************/
     83          uint32 _zdoCallbackSub;
     84          
     85          /**************************************************************************************************
     86           * LOCAL VARIABLES
     87           **************************************************************************************************/
     88          
     89          /**************************************************************************************************
     90           * LOCAL FUNCTIONS
     91           **************************************************************************************************/
     92          #if defined (MT_ZDO_FUNC)
     93          void MT_ZdoNWKAddressRequest(uint8 *pBuf);
     94          void MT_ZdoIEEEAddrRequest(uint8 *pBuf);
     95          void MT_ZdoNodeDescRequest(uint8 *pBuf);
     96          void MT_ZdoPowerDescRequest(uint8 *pBuf);
     97          void MT_ZdoSimpleDescRequest(uint8 *pBuf);
     98          void MT_ZdoActiveEpRequest(uint8 *pBuf);
     99          void MT_ZdoMatchDescRequest(uint8 *pBuf);
    100          void MT_ZdoComplexDescRequest(uint8 *pBuf);
    101          void MT_ZdoUserDescRequest(uint8 *pBuf);
    102          void MT_ZdoEndDevAnnce(uint8 *pBuf);
    103          void MT_ZdoUserDescSet(uint8 *pBuf);
    104          void MT_ZdoServiceDiscRequest(uint8 *pBuf);
    105          void MT_ZdoEndDevBindRequest(uint8 *pBuf);
    106          void MT_ZdoBindRequest(uint8 *pBuf);
    107          void MT_ZdoUnbindRequest(uint8 *pBuf);
    108          void MT_ZdoMgmtNwkDiscRequest(uint8 *pBuf);
    109          void MT_ZdoSetLinkKey(uint8 *pBuf);
    110          void MT_ZdoRemoveLinkKey(uint8 *pBuf);
    111          void MT_ZdoGetLinkKey(uint8 *pBuf);
    112          #if defined (MT_ZDO_MGMT)
    113          void MT_ZdoMgmtLqiRequest(uint8 *pBuf);
    114          void MT_ZdoMgmtRtgRequest(uint8 *pBuf);
    115          void MT_ZdoMgmtBindRequest(uint8 *pBuf);
    116          void MT_ZdoMgmtLeaveRequest(uint8 *pBuf);
    117          void MT_ZdoMgmtDirectJoinRequest(uint8 *pBuf);
    118          void MT_ZdoMgmtPermitJoinRequest(uint8 *pBuf);
    119          void MT_ZdoMgmtNwkUpdateRequest(uint8 *pBuf);
    120          #endif /* MT_ZDO_MGMT */
    121          void MT_ZdoStartupFromApp(uint8 *pBuf);
    122          void MT_ZdoRegisterForZDOMsg(uint8 *pBuf);
    123          void MT_ZdoRemoveRegisteredCB(uint8 *pBuf);
    124          #endif /* MT_ZDO_FUNC */
    125          
    126          #if defined (MT_ZDO_CB_FUNC)
    127          uint8 MT_ZdoHandleExceptions( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg );
    128          void MT_ZdoAddrRspCB( ZDO_NwkIEEEAddrResp_t *pMsg, uint16 clusterID );
    129          void MT_ZdoEndDevAnnceCB( ZDO_DeviceAnnce_t *pMsg, uint16 srcAddr );
    130          void MT_ZdoBindUnbindRspCB( uint16 clusterID, uint16 srcAddr, uint8 status );
    131          void* MT_ZdoSrcRtgCB( void *pStr );
    132          #endif /* MT_ZDO_CB_FUNC */
    133          
    134          #if defined (MT_ZDO_FUNC)
    135          /***************************************************************************************************
    136           * @fn      MT_ZdoInit
    137           *
    138           * @brief   MT ZDO initialization
    139           *
    140           * @param   none
    141           *
    142           * @return  none
    143           ***************************************************************************************************/
    144          void MT_ZdoInit(void)
    145          {
    146          #ifdef MT_ZDO_CB_FUNC
    147            /* Register with ZDO for indication callbacks */
    148            ZDO_RegisterForZdoCB(ZDO_SRC_RTG_IND_CBID, &MT_ZdoSrcRtgCB);
    149          #endif
    150          }
    151          
    152          /***************************************************************************************************
    153           * @fn      MT_ZdoCommandProcessing
    154           *
    155           * @brief
    156           *
    157           *   Process all the ZDO commands that are issued by test tool
    158           *
    159           * @param   pBuf - pointer to the msg buffer
    160           *
    161           *          | LEN  | CMD0  | CMD1  |  DATA  |
    162           *          |  1   |   1   |   1   |  0-255 |
    163           *
    164           * @return  status
    165           ***************************************************************************************************/
    166          uint8 MT_ZdoCommandProcessing(uint8* pBuf)
    167          {
    168            uint8 status = MT_RPC_SUCCESS;
    169          
    170            switch (pBuf[MT_RPC_POS_CMD1])
    171            {
    172          #if defined ( ZDO_NWKADDR_REQUEST )
    173              case MT_ZDO_NWK_ADDR_REQ:
    174                MT_ZdoNWKAddressRequest(pBuf);
    175                break;
    176          #endif
    177          
    178          #if defined ( ZDO_IEEEADDR_REQUEST )
    179              case MT_ZDO_IEEE_ADDR_REQ:
    180                MT_ZdoIEEEAddrRequest(pBuf);
    181                break;
    182          #endif
    183          
    184          #if defined ( ZDO_NODEDESC_REQUEST )
    185              case MT_ZDO_NODE_DESC_REQ:
    186                MT_ZdoNodeDescRequest(pBuf);
    187                break;
    188          #endif
    189          
    190          #if defined ( ZDO_POWERDESC_REQUEST )
    191              case MT_ZDO_POWER_DESC_REQ:
    192                MT_ZdoPowerDescRequest(pBuf);
    193                break;
    194          #endif
    195          
    196          #if defined ( ZDO_SIMPLEDESC_REQUEST )
    197              case MT_ZDO_SIMPLE_DESC_REQ:
    198                MT_ZdoSimpleDescRequest(pBuf);
    199                break;
    200          #endif
    201          
    202          #if defined ( ZDO_ACTIVEEP_REQUEST )
    203              case MT_ZDO_ACTIVE_EP_REQ:
    204                MT_ZdoActiveEpRequest(pBuf);
    205                break;
    206          #endif
    207          
    208          #if defined ( ZDO_MATCH_REQUEST )
    209              case MT_ZDO_MATCH_DESC_REQ:
    210                MT_ZdoMatchDescRequest(pBuf);
    211                break;
    212          #endif
    213          
    214          #if defined ( ZDO_COMPLEXDESC_REQUEST )
    215              case MT_ZDO_COMPLEX_DESC_REQ:
    216                MT_ZdoComplexDescRequest(pBuf);
    217                break;
    218          #endif
    219          
    220          #if defined ( ZDO_USERDESC_REQUEST )
    221              case MT_ZDO_USER_DESC_REQ:
    222                MT_ZdoUserDescRequest(pBuf);
    223                break;
    224          #endif
    225          
    226          #if defined ( ZDO_ENDDEVICE_ANNCE )
    227              case MT_ZDO_END_DEV_ANNCE:
    228                MT_ZdoEndDevAnnce(pBuf);
    229                break;
    230          #endif      
    231          
    232          #if defined ( ZDO_USERDESCSET_REQUEST )
    233              case MT_ZDO_USER_DESC_SET:
    234                MT_ZdoUserDescSet(pBuf);
    235                break;
    236          #endif
    237          
    238          #if defined ( ZDO_SERVERDISC_REQUEST )
    239              case MT_ZDO_SERVICE_DISC_REQ:
    240                MT_ZdoServiceDiscRequest(pBuf);
    241                break;
    242          #endif
    243          
    244          #if defined ( ZDO_ENDDEVICEBIND_REQUEST )
    245              case MT_ZDO_END_DEV_BIND_REQ:
    246                MT_ZdoEndDevBindRequest(pBuf);
    247                break;
    248          #endif
    249          
    250          #if defined ( ZDO_BIND_UNBIND_REQUEST )
    251              case MT_ZDO_BIND_REQ:
    252                MT_ZdoBindRequest(pBuf);
    253                break;
    254          #endif
    255          
    256          #if defined ( ZDO_BIND_UNBIND_REQUEST )
    257              case MT_ZDO_UNBIND_REQ:
    258                MT_ZdoUnbindRequest(pBuf);
    259                break;
    260          #endif
    261                
    262          #if defined ( ZDO_LINK_KEY_MANAGEMENT )
    263              case MT_ZDO_SET_LINK_KEY:
    264                MT_ZdoSetLinkKey(pBuf);
    265                break;
    266          
    267              case MT_ZDO_REMOVE_LINK_KEY:
    268                MT_ZdoRemoveLinkKey(pBuf);
    269                break;
    270          
    271              case MT_ZDO_GET_LINK_KEY:
    272                MT_ZdoGetLinkKey(pBuf);
    273                break;
    274          #endif      
    275          
    276          #if defined ( ZDO_MGMT_NWKDISC_REQUEST )
    277              case MT_ZDO_MGMT_NWKDISC_REQ:
    278                MT_ZdoMgmtNwkDiscRequest(pBuf);
    279                break;
    280          #endif
    281          
    282          #if defined ( ZDO_MGMT_LQI_REQUEST )
    283              case MT_ZDO_MGMT_LQI_REQ:
    284                MT_ZdoMgmtLqiRequest(pBuf);
    285                break;
    286          #endif
    287          
    288          #if defined ( ZDO_MGMT_RTG_REQUEST )
    289              case MT_ZDO_MGMT_RTG_REQ:
    290                MT_ZdoMgmtRtgRequest(pBuf);
    291                break;
    292          #endif
    293          
    294          #if defined ( ZDO_MGMT_BIND_REQUEST )
    295              case MT_ZDO_MGMT_BIND_REQ:
    296                MT_ZdoMgmtBindRequest(pBuf);
    297                break;
    298          #endif
    299          
    300          #if defined ( ZDO_MGMT_LEAVE_REQUEST )
    301              case MT_ZDO_MGMT_LEAVE_REQ:
    302                MT_ZdoMgmtLeaveRequest(pBuf);
    303                break;
    304          #endif
    305          
    306          #if defined ( ZDO_MGMT_JOINDIRECT_REQUEST )
    307              case MT_ZDO_MGMT_DIRECT_JOIN_REQ:
    308                MT_ZdoMgmtDirectJoinRequest(pBuf);
    309                break;
    310          #endif
    311          
    312          #if defined ( ZDO_MGMT_PERMIT_JOIN_REQUEST )
    313              case MT_ZDO_MGMT_PERMIT_JOIN_REQ:
    314                MT_ZdoMgmtPermitJoinRequest(pBuf);
    315                break;
    316          #endif
    317          
    318          #if defined ( ZDO_MGMT_NWKUPDATE_REQUEST )
    319              case MT_ZDO_MGMT_NWK_UPDATE_REQ:
    320                MT_ZdoMgmtNwkUpdateRequest(pBuf);
    321                break;
    322          #endif 
    323          
    324          #if defined ( ZDO_NETWORKSTART_REQUEST )
    325              case MT_ZDO_STARTUP_FROM_APP:
    326                MT_ZdoStartupFromApp(pBuf);
    327                break;
    328          #endif
    329          
    330              case MT_ZDO_MSG_CB_REGISTER:
    331                MT_ZdoRegisterForZDOMsg(pBuf);
    332                break;
    333          
    334              case MT_ZDO_MSG_CB_REMOVE:
    335                MT_ZdoRemoveRegisteredCB(pBuf);
    336                break;
    337          
    338              default:
    339                status = MT_RPC_ERR_COMMAND_ID;
    340                break;
    341            }
    342          
    343            return status;
    344          }
    345          
    346          /***************************************************************************************************
    347           * @fn      MT_ZdoNwkAddrReq
    348           *
    349           * @brief   Handle a nwk address request.
    350           *
    351           * @param   pData  - MT message data
    352           *
    353           * @return  void
    354           ***************************************************************************************************/
    355          void MT_ZdoNWKAddressRequest(uint8 *pBuf)
    356          {
    357            uint8 cmdId;
    358            uint8 retValue;
    359            uint8 reqType;
    360            uint8 startIndex;
    361            uint8 *pExtAddr;
    362          
    363            /* parse header */
    364            cmdId = pBuf[MT_RPC_POS_CMD1];
    365            pBuf += MT_RPC_FRAME_HDR_SZ;
    366          
    367            /* parse parameters */
    368            pExtAddr = pBuf;
    369            pBuf += Z_EXTADDR_LEN;
    370          
    371            /* Request type */
    372            reqType = *pBuf++;
    373          
    374            /* Start index */
    375            startIndex = *pBuf;
    376          
    377            retValue = (uint8)ZDP_NwkAddrReq(pExtAddr, reqType, startIndex, 0);
    378          
    379            /* Build and send back the response */
    380            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    381          }
    382          
    383          /***************************************************************************************************
    384           * @fn      MT_ZdoIEEEAddrRequest
    385           *
    386           * @brief   Handle a IEEE address request.
    387           *
    388           * @param   pData  - MT message data
    389           *
    390           * @return  void
    391           ***************************************************************************************************/
    392          void MT_ZdoIEEEAddrRequest (uint8 *pBuf)
    393          {
    394            uint8 cmdId;
    395            uint8 retValue;
    396            uint16 shortAddr;
    397            uint8 reqType;
    398            uint8 startIndex;
    399          
    400            /* parse header */
    401            cmdId = pBuf[MT_RPC_POS_CMD1];
    402            pBuf += MT_RPC_FRAME_HDR_SZ;
    403          
    404            /* Dev address */
    405            shortAddr = BUILD_UINT16(pBuf[0], pBuf[1]);
    406            pBuf += 2;
    407          
    408            /* request type */
    409            reqType = *pBuf++;
    410          
    411            /* start index */
    412            startIndex = *pBuf;
    413          
    414            retValue = (uint8)ZDP_IEEEAddrReq(shortAddr, reqType, startIndex, 0);
    415          
    416            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    417          }
    418          
    419          /***************************************************************************************************
    420           * @fn      MT_ZdoNodeDescRequest
    421           *
    422           * @brief   Handle a Node Descriptor request.
    423           *
    424           * @param   pData  - MT message data
    425           *
    426           * @return  void
    427           ***************************************************************************************************/
    428          void MT_ZdoNodeDescRequest (uint8 *pBuf)
    429          {
    430            uint8 cmdId;
    431            uint8 retValue;
    432            zAddrType_t destAddr;
    433            uint16 shortAddr;
    434          
    435            /* parse header */
    436            cmdId = pBuf[MT_RPC_POS_CMD1];
    437            pBuf += MT_RPC_FRAME_HDR_SZ;
    438          
    439            /* Destination address */
    440            destAddr.addrMode = Addr16Bit;
    441            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    442            pBuf += 2;
    443          
    444            /* Network address of interest */
    445            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    446            pBuf += 2;
    447          
    448            retValue = (uint8)ZDP_NodeDescReq( &destAddr, shortAddr, 0);
    449          
    450            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    451          }
    452          
    453          /***************************************************************************************************
    454           * @fn      MT_ZdoPowerDescRequest
    455           *
    456           * @brief   Handle a Power Descriptor request.
    457           *
    458           * @param   pData  - MT message data
    459           *
    460           * @return  void
    461           ***************************************************************************************************/
    462          void MT_ZdoPowerDescRequest(uint8 *pBuf)
    463          {
    464            uint8 cmdId;
    465            uint8 retValue;
    466            zAddrType_t destAddr;
    467            uint16 shortAddr;
    468          
    469            /* parse header */
    470            cmdId = pBuf[MT_RPC_POS_CMD1];
    471            pBuf += MT_RPC_FRAME_HDR_SZ;
    472          
    473            /* Dev address */
    474            destAddr.addrMode = Addr16Bit;
    475            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    476            pBuf += 2;
    477          
    478            /* Network address of interest */
    479            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    480            pBuf += 2;
    481          
    482            retValue = (uint8)ZDP_PowerDescReq( &destAddr, shortAddr, 0);
    483          
    484            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    485          }
    486          
    487          /***************************************************************************************************
    488           * @fn      MT_ZdoSimpleDescRequest
    489           *
    490           * @brief   Handle a Simple Descriptor request.
    491           *
    492           * @param   pBuf  - MT message data
    493           *
    494           * @return  void
    495           ***************************************************************************************************/
    496          void MT_ZdoSimpleDescRequest(uint8 *pBuf)
    497          {
    498            uint8 cmdId;
    499            uint8 retValue;
    500            uint8 epInt;
    501            zAddrType_t destAddr;
    502            uint16 shortAddr;
    503          
    504            /* parse header */
    505            cmdId = pBuf[MT_RPC_POS_CMD1];
    506            pBuf += MT_RPC_FRAME_HDR_SZ;
    507          
    508            /* Dev address */
    509            destAddr.addrMode = Addr16Bit;
    510            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    511            pBuf += 2;
    512          
    513            /* Network address of interest */
    514            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    515            pBuf += 2;
    516          
    517            /* endpoint/interface */
    518            epInt = *pBuf++;
    519          
    520            retValue = (uint8)ZDP_SimpleDescReq( &destAddr, shortAddr, epInt, 0);
    521          
    522            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    523          }
    524          
    525          /***************************************************************************************************
    526           * @fn      MT_ZdoActiveEpRequest
    527           *
    528           * @brief   Handle a Active EP request.
    529           *
    530           * @param   pBuf  - MT message data
    531           *
    532           * @return  void
    533           ***************************************************************************************************/
    534          void MT_ZdoActiveEpRequest(uint8 *pBuf)
    535          {
    536            uint8 cmdId;
    537            uint8 retValue;
    538            zAddrType_t destAddr;
    539            uint16 shortAddr;
    540          
    541            /* parse header */
    542            cmdId = pBuf[MT_RPC_POS_CMD1];
    543            pBuf += MT_RPC_FRAME_HDR_SZ;
    544          
    545            /* Dev address */
    546            destAddr.addrMode = Addr16Bit;
    547            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    548            pBuf += 2;
    549          
    550            /* Network address of interest */
    551            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    552            pBuf += 2;
    553          
    554            retValue = (uint8)ZDP_ActiveEPReq( &destAddr, shortAddr, 0);
    555          
    556            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    557          }
    558          
    559          /***************************************************************************************************
    560           * @fn      MT_ZdoMatchDescRequest
    561           *
    562           * @brief   Handle a Match Descriptor request.
    563           *
    564           * @param   pBuf  - MT message data
    565           *
    566           * @return  void
    567           ***************************************************************************************************/
    568          void MT_ZdoMatchDescRequest(uint8 *pBuf)
    569          {
    570            uint8 cmdId;
    571            uint8 retValue = 0;
    572            uint8 i, numInClusters, numOutClusters;
    573            uint16 profileId;
    574            zAddrType_t destAddr;
    575            uint16 shortAddr;
    576            uint16 inClusters[MTZDO_MAX_MATCH_CLUSTERS], outClusters[MTZDO_MAX_MATCH_CLUSTERS];
    577          
    578            /* parse header */
    579            cmdId = pBuf[MT_RPC_POS_CMD1];
    580            pBuf += MT_RPC_FRAME_HDR_SZ;
    581          
    582            /* Dev address */
    583            destAddr.addrMode = Addr16Bit;
    584            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    585            pBuf += 2;
    586          
    587            /* Network address of interest */
    588            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    589            pBuf += 2;
    590          
    591            /* Profile ID */
    592            profileId = BUILD_UINT16( pBuf[0], pBuf[1] );
    593            pBuf += 2;
    594          
    595            /* NumInClusters */
    596            numInClusters = *pBuf++;
    597            if ( numInClusters <= MTZDO_MAX_MATCH_CLUSTERS )
    598            {
    599              /* IN clusters */
    600              for ( i = 0; i < numInClusters; i++ )
    601              {
    602                inClusters[i] = BUILD_UINT16( pBuf[0], pBuf[1]);
    603                pBuf += 2;
    604              }
    605            }
    606            else
    607            {
    608              retValue = ZDP_INVALID_REQTYPE;
    609            }
    610          
    611            /* NumOutClusters */
    612            numOutClusters = *pBuf++;
    613            if ( numOutClusters <= MTZDO_MAX_MATCH_CLUSTERS )
    614            {
    615              /* OUT Clusters */
    616              for ( i = 0; i < numOutClusters; i++ )
    617              {
    618                outClusters[i] = BUILD_UINT16( pBuf[0], pBuf[1]);
    619                pBuf += 2;
    620              }
    621            }
    622            else
    623            {
    624              retValue = ZDP_INVALID_REQTYPE;
    625            }
    626          
    627            if ( retValue == 0 )
    628            {
    629              retValue = (uint8)ZDP_MatchDescReq( &destAddr, shortAddr, profileId, numInClusters,
    630                                                 inClusters, numOutClusters, outClusters, 0);
    631            }
    632          
    633            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    634          }
    635          
    636          /***************************************************************************************************
    637           * @fn      MT_ZdoComplexDescRequest
    638           *
    639           * @brief   Handle a Complex Descriptor request.
    640           *
    641           * @param   pBuf  - MT message data
    642           *
    643           * @return  void
    644           ***************************************************************************************************/
    645          void MT_ZdoComplexDescRequest(uint8 *pBuf)
    646          {
    647            uint8 cmdId;
    648            uint8 retValue;
    649            zAddrType_t destAddr;
    650            uint16 shortAddr;
    651          
    652            /* parse header */
    653            cmdId = pBuf[MT_RPC_POS_CMD1];
    654            pBuf += MT_RPC_FRAME_HDR_SZ;
    655          
    656            /* Dev address */
    657            destAddr.addrMode = Addr16Bit;
    658            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    659            pBuf += 2;
    660          
    661            /* Network address of interest */
    662            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    663            pBuf += 2;
    664          
    665            retValue = (uint8)ZDP_ComplexDescReq( &destAddr, shortAddr, 0);
    666          
    667            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    668          }
    669          
    670          /***************************************************************************************************
    671           * @fn      MT_ZdoUserDescRequest
    672           *
    673           * @brief   Handle a User Descriptor request.
    674           *
    675           * @param   pBuf  - MT message data
    676           *
    677           * @return  void
    678           ***************************************************************************************************/
    679          void MT_ZdoUserDescRequest(uint8 *pBuf)
    680          {
    681            uint8 cmdId;
    682            uint8 retValue;
    683            zAddrType_t destAddr;
    684            uint16 shortAddr;
    685          
    686            /* parse header */
    687            cmdId = pBuf[MT_RPC_POS_CMD1];
    688            pBuf += MT_RPC_FRAME_HDR_SZ;
    689          
    690            /* Dev address */
    691            destAddr.addrMode = Addr16Bit;
    692            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
    693            pBuf += 2;
    694          
    695            /* Network address of interest */
    696            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
    697            pBuf += 2;
    698          
    699            retValue = (uint8)ZDP_UserDescReq( &destAddr, shortAddr, 0);
    700          
    701            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    702          }
    703          
    704          /***************************************************************************************************
    705           * @fn      MT_ZdoEndDevAnnce
    706           *
    707           * @brief   Handle a End Device Announce Descriptor request.
    708           *
    709           * @param   pBuf  - MT message data
    710           *
    711           * @return  void
    712           ***************************************************************************************************/
    713          void MT_ZdoEndDevAnnce(uint8 *pBuf)
    714          {
    715            uint8 cmdId;
    716            uint8 retValue;
    717            uint16 shortAddr;
    718            uint8 *pIEEEAddr;
    719          
    720            /* parse header */
    721            cmdId = pBuf[MT_RPC_POS_CMD1];
    722            pBuf += MT_RPC_FRAME_HDR_SZ;
    723          
    724            /* network address */
    725            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    726            pBuf += 2;
    727          
    728            /* extended address */
    729            pIEEEAddr = pBuf;
    730            pBuf += Z_EXTADDR_LEN;
    731          
    732            retValue = (uint8)ZDP_DeviceAnnce( shortAddr, pIEEEAddr, *pBuf, 0);
    733          
    734            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    735          }
    736          
    737          /***************************************************************************************************
    738           * @fn      MT_ZdoUserDescSet
    739           *
    740           * @brief   Handle a User Descriptor Set.
    741           *
    742           * @param   pBuf  - MT message data
    743           *
    744           * @return  void
    745           ***************************************************************************************************/
    746          void MT_ZdoUserDescSet(uint8 *pBuf)
    747          {
    748            uint8 cmdId;
    749            uint8 retValue;
    750            zAddrType_t destAddr;
    751            uint16 shortAddr;
    752            UserDescriptorFormat_t userDesc;
    753          
    754            /* parse header */
    755            cmdId = pBuf[MT_RPC_POS_CMD1];
    756            pBuf += MT_RPC_FRAME_HDR_SZ;
    757          
    758            /* Dev address */
    759            destAddr.addrMode = Addr16Bit;
    760            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    761            pBuf += 2;
    762          
    763            /* Network address of interest */
    764            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    765            pBuf += 2;
    766          
    767            /* User descriptor */
    768            userDesc.len = *pBuf++;
    769            osal_memcpy( userDesc.desc, pBuf, userDesc.len );
    770            pBuf += 16;
    771          
    772            retValue = (uint8)ZDP_UserDescSet( &destAddr, shortAddr, &userDesc, 0);
    773          
    774            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    775          }
    776          
    777          /***************************************************************************************************
    778           * @fn      MT_ZdoServiceDiscRequest
    779           *
    780           * @brief   Handle a Server Discovery request.
    781           *
    782           * @param   pBuf  - MT message data
    783           *
    784           * @return  void
    785           ***************************************************************************************************/
    786          void MT_ZdoServiceDiscRequest(uint8 *pBuf)
    787          {
    788            uint8 cmdId;
    789            uint8 retValue;
    790            uint16 serviceMask;
    791          
    792            /* parse header */
    793            cmdId = pBuf[MT_RPC_POS_CMD1];
    794            pBuf += MT_RPC_FRAME_HDR_SZ;
    795          
    796            /* Service Mask */
    797            serviceMask = BUILD_UINT16( pBuf[0], pBuf[1]);
    798            pBuf += 2;
    799          
    800            retValue = (uint8)ZDP_ServerDiscReq( serviceMask, 0);
    801          
    802            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    803          }
    804          
    805          /***************************************************************************************************
    806           * @fn      MT_ZdoEndDevBindRequest
    807           *
    808           * @brief   Handle a End Device Bind request.
    809           *
    810           * @param   pBuf  - MT message data
    811           *
    812           * @return  void
    813           ***************************************************************************************************/
    814          void MT_ZdoEndDevBindRequest(uint8 *pBuf)
    815          {
    816            uint8 cmdId;
    817            uint8 retValue = 0;
    818            uint8 i, epInt, numInClusters, numOutClusters;
    819            zAddrType_t destAddr;
    820            uint16 shortAddr;
    821            uint16 profileID, inClusters[MTZDO_MAX_ED_BIND_CLUSTERS], outClusters[MTZDO_MAX_ED_BIND_CLUSTERS];
    822          
    823            /* parse header */
    824            cmdId = pBuf[MT_RPC_POS_CMD1];
    825            pBuf += MT_RPC_FRAME_HDR_SZ;
    826          
    827            /* Dev address */
    828            destAddr.addrMode = Addr16Bit;
    829            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    830            pBuf += 2;
    831          
    832            /* Local coordinator of the binding */
    833            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    834            pBuf += 2;
    835            
    836            /* For now, skip past the extended address */
    837            pBuf += Z_EXTADDR_LEN;
    838          
    839            /* Endpoint */
    840            epInt = *pBuf++;
    841          
    842            /* Profile ID */
    843            profileID = BUILD_UINT16( pBuf[0], pBuf[1] );
    844            pBuf += 2;
    845          
    846            /* NumInClusters */
    847            numInClusters = *pBuf++;
    848            if ( numInClusters <= MTZDO_MAX_ED_BIND_CLUSTERS )
    849            {
    850              for ( i = 0; i < numInClusters; i++ )
    851              {
    852                inClusters[i] = BUILD_UINT16(pBuf[0], pBuf[1]);
    853                pBuf += 2;
    854              }
    855            }
    856            else
    857              retValue = ZDP_INVALID_REQTYPE;
    858          
    859            /* NumOutClusters */
    860            numOutClusters = *pBuf++;
    861            if ( numOutClusters <= MTZDO_MAX_ED_BIND_CLUSTERS )
    862            {
    863              for ( i = 0; i < numOutClusters; i++ )
    864              {
    865                outClusters[i] = BUILD_UINT16(pBuf[0], pBuf[1]);
    866                pBuf += 2;
    867              }
    868            }
    869            else
    870              retValue = ZDP_INVALID_REQTYPE;
    871            
    872            if ( retValue == 0 )
    873            {
    874              retValue = (uint8)ZDP_EndDeviceBindReq( &destAddr, shortAddr, epInt, profileID,
    875                                                    numInClusters, inClusters, numOutClusters, outClusters, 0);
    876            }
    877          
    878            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    879          }
    880          
    881          /***************************************************************************************************
    882           * @fn      MT_ZdoBindRequest
    883           *
    884           * @brief   Handle a Bind request.
    885           *
    886           * @param   pBuf  - MT message data
    887           *
    888           * @return  void
    889           ***************************************************************************************************/
    890          void MT_ZdoBindRequest(uint8 *pBuf)
    891          {
    892            uint8 cmdId;
    893            uint8 retValue;
    894            zAddrType_t destAddr, devAddr;
    895            uint8 *pSrcAddr, *ptr;
    896            uint8 srcEPInt, dstEPInt;
    897            uint16 clusterID;
    898          
    899            /* parse header */
    900            cmdId = pBuf[MT_RPC_POS_CMD1];
    901            pBuf += MT_RPC_FRAME_HDR_SZ;
    902          
    903            /* Dev address */
    904            destAddr.addrMode = Addr16Bit;
    905            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    906            pBuf += 2;
    907          
    908            /* SrcAddress */
    909            pSrcAddr = pBuf;
    910            pBuf += Z_EXTADDR_LEN;
    911          
    912            /* SrcEPInt */
    913            srcEPInt = *pBuf++;
    914          
    915            /* ClusterID */
    916            clusterID = BUILD_UINT16( pBuf[0], pBuf[1]);
    917            pBuf += 2;
    918          
    919            /* Destination Address mode */
    920            devAddr.addrMode = *pBuf++;
    921          
    922            /* Destination Address */
    923            if ( devAddr.addrMode == Addr64Bit )
    924            {
    925              ptr = pBuf;
    926              osal_cpyExtAddr( devAddr.addr.extAddr, ptr );
    927            }
    928            else
    929            {
    930              devAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    931            }
    932            /* The short address occupies LSB two bytes */
    933            pBuf += Z_EXTADDR_LEN;
    934          
    935            /* DstEPInt */
    936            dstEPInt = *pBuf;
    937          
    938            retValue = (uint8)ZDP_BindReq( &destAddr, pSrcAddr, srcEPInt, clusterID, &devAddr, dstEPInt, 0);
    939          
    940            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    941          }
    942          
    943          /***************************************************************************************************
    944           * @fn      MT_ZdoUnbindRequest
    945           *
    946           * @brief   Handle a Unbind request.
    947           *
    948           * @param   pBuf  - MT message data
    949           *
    950           * @return  void
    951           ***************************************************************************************************/
    952          void MT_ZdoUnbindRequest(uint8 *pBuf)
    953          {
    954            uint8 cmdId;
    955            uint8 retValue;
    956            zAddrType_t destAddr, devAddr;
    957            uint8 *pSrcAddr, *ptr;
    958            uint8 srcEPInt, dstEPInt;
    959            uint16 clusterID;
    960          
    961            /* parse header */
    962            cmdId = pBuf[MT_RPC_POS_CMD1];
    963            pBuf += MT_RPC_FRAME_HDR_SZ;
    964          
    965            /* dev address */
    966            destAddr.addrMode = Addr16Bit;
    967            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    968            pBuf += 2;
    969          
    970            /* SrcAddress */
    971            pSrcAddr = pBuf;
    972            pBuf += Z_EXTADDR_LEN;
    973          
    974            /* SrcEPInt */
    975            srcEPInt = *pBuf++;
    976          
    977            /* ClusterID */
    978            clusterID = BUILD_UINT16( pBuf[0], pBuf[1]);
    979            pBuf += 2;
    980          
    981            /* Destination Address mode */
    982            devAddr.addrMode = *pBuf++;
    983          
    984            /* Destination Address */
    985            if ( devAddr.addrMode == Addr64Bit )
    986            {
    987              ptr = pBuf;
    988              osal_cpyExtAddr( devAddr.addr.extAddr, ptr );
    989            }
    990            else
    991            {
    992              devAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    993            }
    994            /* The short address occupies LSB two bytes */
    995            pBuf += Z_EXTADDR_LEN;
    996          
    997            /* dstEPInt */
    998            dstEPInt = *pBuf;
    999          
   1000            retValue = (uint8)ZDP_UnbindReq( &destAddr, pSrcAddr, srcEPInt, clusterID, &devAddr, dstEPInt, 0);
   1001          
   1002            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1003          }
   1004          
   1005          /***************************************************************************************************
   1006           * @fn      MT_ZdoSetLinkKey
   1007           *
   1008           * @brief   Set an application or trust center link key.
   1009           *
   1010           * @param   pBuf  - MT message data
   1011           *
   1012           * @return  void
   1013           ***************************************************************************************************/
   1014          void MT_ZdoSetLinkKey(uint8 *pBuf)
   1015          {
   1016            uint8 cmdId;
   1017            uint8 retValue;
   1018            uint8 *pExtAddr;
   1019            uint8 *pKey;
   1020            uint16 shortAddr;
   1021            
   1022            /* parse header */
   1023            cmdId = pBuf[MT_RPC_POS_CMD1];
   1024            pBuf += MT_RPC_FRAME_HDR_SZ;
   1025          
   1026            /* ShortAddr */
   1027            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1028            pBuf += 2;
   1029            
   1030            /* Extended Addr */
   1031            pExtAddr = pBuf;
   1032            pBuf += Z_EXTADDR_LEN;
   1033            
   1034            /* Key data */
   1035            pKey = pBuf;
   1036          
   1037            retValue = (uint8)ZDSecMgrAddLinkKey( shortAddr, pExtAddr, pKey);
   1038          
   1039            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1040          }
   1041          
   1042          /***************************************************************************************************
   1043           * @fn      MT_ZdoRemoveLinkKey
   1044           *
   1045           * @brief   Remove an application or trust center link key.
   1046           *
   1047           * @param   pBuf  - MT message data
   1048           *
   1049           * @return  void
   1050           ***************************************************************************************************/
   1051          void MT_ZdoRemoveLinkKey(uint8 *pBuf)
   1052          {
   1053            uint8 cmdId;
   1054            uint8 retValue;
   1055            uint8 *pExtAddr;
   1056              
   1057            /* parse header */
   1058            cmdId = pBuf[MT_RPC_POS_CMD1];
   1059            pBuf += MT_RPC_FRAME_HDR_SZ;
   1060            
   1061            /* ShortAddr */
   1062            pExtAddr = pBuf;
   1063          
   1064            retValue = ZDSecMgrDeviceRemoveByExtAddr( pExtAddr );
   1065          
   1066            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1067          }
   1068          
   1069          /***************************************************************************************************
   1070           * @fn      MT_ZdoGetLinkKey
   1071           *
   1072           * @brief   Get the application or trust center link key.
   1073           *
   1074           * @param   pBuf  - MT message data
   1075           *
   1076           * @return  void
   1077           ***************************************************************************************************/
   1078          void MT_ZdoGetLinkKey(uint8 *pBuf)
   1079          {
   1080            uint8 cmdId;
   1081            uint8 retValue;
   1082            uint8 *pExtAddr;
   1083            uint8 *retBuf;
   1084            uint8 len;
   1085            APSME_LinkKeyData_t *pLinkKey;
   1086              
   1087            /* parse header */
   1088            cmdId = pBuf[MT_RPC_POS_CMD1];
   1089            pBuf += MT_RPC_FRAME_HDR_SZ;
   1090            
   1091            /* Extended Address */
   1092            pExtAddr = pBuf;
   1093          
   1094            /* Fetch the key data */
   1095            retValue = APSME_LinkKeyDataGet( pExtAddr, &pLinkKey );
   1096            
   1097            /* Construct the response message */
   1098            len = 1 + Z_EXTADDR_LEN + SEC_KEY_LEN; // status + extAddr + key
   1099            if ( ( retBuf = osal_mem_alloc( len ) ) == NULL )
   1100            {
   1101              retValue = ZMemError;
   1102            }
   1103            else
   1104            {  
   1105              if( retValue == ZSuccess )
   1106              {
   1107                /* Extended Address */
   1108                osal_memcpy( &(retBuf[1]), pExtAddr, Z_EXTADDR_LEN );
   1109                
   1110                /* Key data */
   1111                osal_memcpy( &(retBuf[1 + Z_EXTADDR_LEN]), pLinkKey->key, SEC_KEY_LEN );      
   1112              }
   1113            }
   1114              
   1115            if( retValue != ZSuccess )
   1116            {
   1117              /* Failed case - set the rest fields to all FF */
   1118              osal_memset( &(retBuf[1]), 0xFF, Z_EXTADDR_LEN + SEC_KEY_LEN );   
   1119            }    
   1120            
   1121            retBuf[0] = retValue;  /* Status */
   1122            
   1123            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, len, retBuf);
   1124            
   1125            return;
   1126          }
   1127          
   1128          #if defined (MT_ZDO_MGMT)
   1129          /***************************************************************************************************
   1130           * @fn      MT_ZdoMgmtNwkDiscRequest
   1131           *
   1132           * @brief   Handle a Mgmt Nwk Discovery request.
   1133           *
   1134           * @param   pBuf  - MT message data
   1135           *
   1136           * @return  void
   1137           ***************************************************************************************************/
   1138          void MT_ZdoMgmtNwkDiscRequest(uint8 *pBuf)
   1139          {
   1140            uint8 cmdId;
   1141            uint8 retValue;
   1142            zAddrType_t destAddr;
   1143            uint32 scanChannels;
   1144            uint8 scanDuration, startIndex;
   1145          
   1146            /* parse header */
   1147            cmdId = pBuf[MT_RPC_POS_CMD1];
   1148            pBuf += MT_RPC_FRAME_HDR_SZ;
   1149          
   1150            /* Dev address */
   1151            destAddr.addrMode = Addr16Bit;
   1152            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1153            pBuf += 2;
   1154          
   1155            /* Scan Channels */
   1156            scanChannels = BUILD_UINT32( pBuf[0], pBuf[1], pBuf[2], pBuf[3] );
   1157            pBuf += 4;
   1158          
   1159            /* Scan Duration */
   1160            scanDuration = *pBuf++;
   1161          
   1162            /* Start Index */
   1163            startIndex = *pBuf;
   1164          
   1165            retValue = (uint8)ZDP_MgmtNwkDiscReq( &destAddr, scanChannels, scanDuration, startIndex, 0);
   1166          
   1167            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1168          }
   1169          
   1170          /***************************************************************************************************
   1171           * @fn      MT_ZdoMgmtLqiRequest
   1172           *
   1173           * @brief   Handle a Mgmt Lqi request.
   1174           *
   1175           * @param   pBuf  - MT message data
   1176           *
   1177           * @return  void
   1178           ***************************************************************************************************/
   1179          void MT_ZdoMgmtLqiRequest(uint8 *pBuf)
   1180          {
   1181            uint8 cmdId;
   1182            uint8 retValue;
   1183            zAddrType_t destAddr;
   1184            uint8 startIndex;
   1185          
   1186            /* parse header */
   1187            cmdId = pBuf[MT_RPC_POS_CMD1];
   1188            pBuf += MT_RPC_FRAME_HDR_SZ;
   1189          
   1190            /* Dev address */
   1191            destAddr.addrMode = Addr16Bit;
   1192            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1193            pBuf += 2;
   1194          
   1195            /* Start Index */
   1196            startIndex = *pBuf;
   1197          
   1198            retValue = (uint8)ZDP_MgmtLqiReq( &destAddr, startIndex, 0);
   1199          
   1200            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1201          }
   1202          
   1203          /***************************************************************************************************
   1204           * @fn      MT_ZdoMgmtRtgRequest
   1205           *
   1206           * @brief   Handle a Mgmt Rtg request.
   1207           *
   1208           * @param   pBuf  - MT message data
   1209           *
   1210           * @return  void
   1211           ***************************************************************************************************/
   1212          void MT_ZdoMgmtRtgRequest(uint8 *pBuf)
   1213          {
   1214            uint8 cmdId;
   1215            uint8 retValue;
   1216            zAddrType_t destAddr;
   1217            uint8 startIndex;
   1218          
   1219            /* parse header */
   1220            cmdId = pBuf[MT_RPC_POS_CMD1];
   1221            pBuf += MT_RPC_FRAME_HDR_SZ;
   1222          
   1223            /* Dev Address */
   1224            destAddr.addrMode = Addr16Bit;
   1225            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
   1226            pBuf += 2;
   1227          
   1228            /* Start Index */
   1229            startIndex = *pBuf;
   1230          
   1231            retValue = (byte)ZDP_MgmtRtgReq( &destAddr, startIndex, 0);
   1232          
   1233            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1234          }
   1235          
   1236          /***************************************************************************************************
   1237           * @fn      MT_ZdoMgmtBindRequest
   1238           *
   1239           * @brief   Handle a Mgmt Bind request.
   1240           *
   1241           * @param   pBuf  - MT message data
   1242           *
   1243           * @return  void
   1244           ***************************************************************************************************/
   1245          void MT_ZdoMgmtBindRequest(uint8 *pBuf)
   1246          {
   1247            uint8 cmdId;
   1248            uint8 retValue;
   1249            zAddrType_t destAddr;
   1250            uint8 startIndex;
   1251          
   1252            /* parse header */
   1253            cmdId = pBuf[MT_RPC_POS_CMD1];
   1254            pBuf += MT_RPC_FRAME_HDR_SZ;
   1255          
   1256            /* Dev Address */
   1257            destAddr.addrMode = Addr16Bit;
   1258            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1259            pBuf += 2;
   1260          
   1261            /* Start Index */
   1262            startIndex = *pBuf;
   1263          
   1264            retValue = (uint8)ZDP_MgmtBindReq( &destAddr, startIndex, 0);
   1265          
   1266            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1267          }
   1268          
   1269          /***************************************************************************************************
   1270           * @fn      MT_ZdoMgmtLeaveRequest
   1271           *
   1272           * @brief   Handle a Mgmt Leave request.
   1273           *
   1274           * @param   pBuf  - MT message data
   1275           *
   1276           * @return  void
   1277           ***************************************************************************************************/
   1278          void MT_ZdoMgmtLeaveRequest(uint8 *pBuf)
   1279          {
   1280            uint8 cmdId;
   1281            uint8 retValue;
   1282            zAddrType_t destAddr;
   1283            uint8 *pIEEEAddr;
   1284            uint8 removeChildren, rejoin;
   1285          
   1286            /* parse header */
   1287            cmdId = pBuf[MT_RPC_POS_CMD1];
   1288            pBuf += MT_RPC_FRAME_HDR_SZ;
   1289          
   1290            /* Destination Address */
   1291            destAddr.addrMode = Addr16Bit;
   1292            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1293            pBuf += 2;
   1294          
   1295            /* IEEE address */
   1296            pIEEEAddr = pBuf;
   1297            pBuf += Z_EXTADDR_LEN;
   1298          
   1299            /* Remove Children */
   1300            removeChildren = *pBuf++;
   1301          
   1302            /* Rejoin */
   1303            rejoin = *pBuf;
   1304          
   1305            retValue = (byte)ZDP_MgmtLeaveReq( &destAddr, pIEEEAddr, removeChildren, rejoin, 0);
   1306          
   1307            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1308          }
   1309          
   1310          
   1311          /***************************************************************************************************
   1312           * @fn      MT_ZdoMgmtDirectJoinRequest
   1313           *
   1314           * @brief   Handle a Mgmt Direct Join request.
   1315           *
   1316           * @param   pBuf  - MT message data
   1317           *
   1318           * @return  void
   1319           ***************************************************************************************************/
   1320          void MT_ZdoMgmtDirectJoinRequest(uint8 *pBuf)
   1321          {
   1322            uint8 cmdId;
   1323            uint8 retValue;
   1324            zAddrType_t destAddr;
   1325            uint8 *deviceAddr;
   1326            uint8 capInfo;
   1327          
   1328            /* parse header */
   1329            cmdId = pBuf[MT_RPC_POS_CMD1];
   1330            pBuf += MT_RPC_FRAME_HDR_SZ;
   1331          
   1332            /* Destination Address */
   1333            destAddr.addrMode = Addr16Bit;
   1334            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1335            pBuf += 2;
   1336          
   1337            /* Device Address */
   1338            deviceAddr = pBuf;
   1339            pBuf += Z_EXTADDR_LEN;
   1340          
   1341            /* Capability information */
   1342            capInfo = *pBuf;
   1343          
   1344            retValue = (uint8)ZDP_MgmtDirectJoinReq( &destAddr, deviceAddr, capInfo, 0);
   1345          
   1346            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1347          }
   1348          
   1349          /***************************************************************************************************
   1350           * @fn      MT_ZdoMgmtPermitJoinRequest
   1351           *
   1352           * @brief   Handle a Mgmt Permit Join request.
   1353           *
   1354           * @param   pBuf  - MT message data
   1355           *
   1356           * @return  void
   1357           ***************************************************************************************************/
   1358          void MT_ZdoMgmtPermitJoinRequest(uint8 *pBuf)
   1359          {
   1360            uint8 cmdId;
   1361            uint8 retValue;
   1362            zAddrType_t destAddr;
   1363            uint8 duration, tcSignificance;
   1364          
   1365            /* parse header */
   1366            cmdId = pBuf[MT_RPC_POS_CMD1];
   1367            pBuf += MT_RPC_FRAME_HDR_SZ;
   1368          
   1369            /* Destination Address */
   1370            destAddr.addrMode = Addr16Bit;
   1371            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1372            pBuf += 2;
   1373          
   1374            /* Duration */
   1375            duration = *pBuf++;
   1376          
   1377            /* Trust center significance */
   1378            tcSignificance = *pBuf;
   1379          
   1380            retValue = (byte)ZDP_MgmtPermitJoinReq( &destAddr, duration, tcSignificance, 0);
   1381          
   1382            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1383          }
   1384          
   1385          /***************************************************************************************************
   1386           * @fn      MT_ZdoMgmtNwkUpdateRequest
   1387           *
   1388           * @brief   Handle a Mgmt Nwk Update request.
   1389           *
   1390           * @param   pBuf  - MT message data
   1391           *
   1392           * @return  void
   1393           ***************************************************************************************************/
   1394          void MT_ZdoMgmtNwkUpdateRequest(uint8 *pBuf)
   1395          {
   1396            uint8 cmdId;
   1397            uint8 retValue;
   1398            zAddrType_t destAddr;
   1399            uint32 channelMask;
   1400            uint8 scanDuration, scanCount;
   1401            uint16 nwkManagerAddr;
   1402          
   1403              /* parse header */
   1404            cmdId = pBuf[MT_RPC_POS_CMD1];
   1405            pBuf += MT_RPC_FRAME_HDR_SZ;
   1406          
   1407            /* Destination address */
   1408            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1409            pBuf += 2;
   1410          
   1411            /* Destination address mode */
   1412            destAddr.addrMode = *pBuf++;
   1413          
   1414            channelMask = BUILD_UINT32( pBuf[0], pBuf[1], pBuf[2], pBuf[3]);
   1415            pBuf += 4;
   1416          
   1417            /* Scan duration */
   1418            scanDuration = *pBuf++;
   1419          
   1420            /* Scan count */
   1421            scanCount = *pBuf++;
   1422          
   1423            /* NWK manager address */
   1424            nwkManagerAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1425          
   1426            /* Send the Management Network Update request */
   1427            retValue = (uint8)ZDP_MgmtNwkUpdateReq( &destAddr, channelMask, scanDuration,
   1428                                                    scanCount, _NIB.nwkUpdateId+1, nwkManagerAddr );
   1429          
   1430            /*
   1431              Since we don't recevied our own broadcast messages, we should
   1432              send a unicast copy of the message to ourself.
   1433            */
   1434            if ( destAddr.addrMode == AddrBroadcast )
   1435            {
   1436              destAddr.addrMode = Addr16Bit;
   1437              destAddr.addr.shortAddr = _NIB.nwkDevAddress;
   1438              retValue = (uint8) ZDP_MgmtNwkUpdateReq( &destAddr, channelMask, scanDuration,
   1439                                                       scanCount, _NIB.nwkUpdateId+1, nwkManagerAddr );
   1440            }
   1441          
   1442            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1443          }
   1444          #endif /* MT_ZDO_MGMT */
   1445          
   1446          /***************************************************************************************************
   1447           * @fn      MT_ZdoStartupFromApp
   1448           *
   1449           * @brief   Handle a Startup from App request.
   1450           *
   1451           * @param   pBuf  - MT message data
   1452           *
   1453           * @return  void
   1454           ***************************************************************************************************/
   1455          void MT_ZdoStartupFromApp(uint8 *pBuf)
   1456          {
   1457            uint8 cmd0, cmd1, retValue;
   1458          
   1459            /* parse header */
   1460            cmd0 = pBuf[MT_RPC_POS_CMD0];
   1461            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1462            pBuf += MT_RPC_FRAME_HDR_SZ;
   1463          
   1464            retValue = ZDOInitDevice(100);
   1465          
   1466            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1467            {
   1468              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1,1, &retValue);
   1469            }
   1470          }
   1471          
   1472          /*************************************************************************************************
   1473           * @fn      MT_ZdoRegisterForZDOMsg(pBuf);
   1474           *
   1475           * @brief   MT proxy for ZDO_RegisterForZDOMsg.
   1476           *
   1477           * @param   pBuf  - MT message data
   1478           *
   1479           * @return  void
   1480           *************************************************************************************************/
   1481          void MT_ZdoRegisterForZDOMsg(uint8 *pBuf)
   1482          {
   1483            uint8 cmd0, cmd1, tmp;
   1484            uint16 cId;
   1485          
   1486            /* parse header */
   1487            cmd0 = pBuf[MT_RPC_POS_CMD0];
   1488            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1489            pBuf += MT_RPC_FRAME_HDR_SZ;
   1490          
   1491            cId = BUILD_UINT16(pBuf[0], pBuf[1]);
   1492            tmp = ZDO_RegisterForZDOMsg(MT_TaskID, cId);
   1493          
   1494            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1495            {
   1496              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1, 1, &tmp);
   1497            }
   1498          }
   1499          
   1500          /*************************************************************************************************
   1501           * @fn      MT_ZdoRemoveRegisteredCB(pBuf);
   1502           *
   1503           * @brief   MT proxy for ZDO_RemoveRegisteredCB.
   1504           *
   1505           * @param   pBuf  - MT message data
   1506           *
   1507           * @return  void
   1508           *************************************************************************************************/
   1509          void MT_ZdoRemoveRegisteredCB(uint8 *pBuf)
   1510          {
   1511            uint8 cmd0, cmd1, tmp;
   1512            uint16 cId;
   1513          
   1514            /* parse header */
   1515            cmd0 = pBuf[MT_RPC_POS_CMD0];
   1516            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1517            pBuf += MT_RPC_FRAME_HDR_SZ;
   1518          
   1519            cId = BUILD_UINT16(pBuf[0], pBuf[1]);
   1520            tmp = ZDO_RemoveRegisteredCB(MT_TaskID, cId);
   1521          
   1522            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1523            {
   1524              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1, 1, &tmp);
   1525            }
   1526          }
   1527          
   1528          #endif /* MT_ZDO_FUNC */
   1529          
   1530          
   1531          /***************************************************************************************************
   1532           * Callback handling function
   1533           ***************************************************************************************************/
   1534          
   1535          #if defined (MT_ZDO_CB_FUNC)
   1536          
   1537          /***************************************************************************************************
   1538           * @fn      MT_ZdoStateChangeCB
   1539           *
   1540           * @brief   Handle state change OSAL message from ZDO.
   1541           *
   1542           * @param   pMsg  - Message data
   1543           *
   1544           * @return  void
   1545           */
   1546          void MT_ZdoStateChangeCB(osal_event_hdr_t *pMsg)
   1547          {
   1548            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1549                                                 MT_ZDO_STATE_CHANGE_IND, 1, &pMsg->status);
   1550          }
   1551          
   1552          /***************************************************************************************************
   1553           * @fn     MT_ZdoDirectCB()
   1554           *
   1555           * @brief  ZDO direct callback.  Build an MT message directly from the
   1556           *         over-the-air ZDO message.
   1557           *
   1558           * @param  pData - Incoming AF frame.
   1559           *
   1560           * @return  none
   1561           ***************************************************************************************************/
   1562          void MT_ZdoDirectCB( afIncomingMSGPacket_t *pData,  zdoIncomingMsg_t *inMsg )
   1563          {
   1564            uint8 len, *pBuf;
   1565            
   1566            // Is the message an exception or not a response?
   1567            if ( MT_ZdoHandleExceptions( pData, inMsg ) || ( (pData->clusterId & ZDO_RESPONSE_BIT) == 0 ) )
   1568            {
   1569              return;  // Handled somewhere else or not needed.
   1570            }
   1571          
   1572            /* ZDO data starts after one-byte sequence number and the msg buffer length includes
   1573             * two bytes for srcAddr.
   1574             */
   1575            len = pData->cmd.DataLength - 1 + sizeof(uint16);
   1576          
   1577            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1578            {
   1579              uint8 id = MT_ZDO_CID_TO_AREQ_ID(pData->clusterId);
   1580          
   1581              pBuf[0] = LO_UINT16(pData->srcAddr.addr.shortAddr);
   1582              pBuf[1] = HI_UINT16(pData->srcAddr.addr.shortAddr);
   1583          
   1584              /* copy ZDO data, skipping one-byte sequence number */
   1585              osal_memcpy(pBuf+2, (pData->cmd.Data + 1), pData->cmd.DataLength-1);
   1586          
   1587              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), id, len, pBuf);
   1588              osal_mem_free(pBuf);
   1589            }
   1590          }
   1591          
   1592          /***************************************************************************************************
   1593           * @fn     MT_ZdoHandleExceptions()
   1594           *
   1595           * @brief  Handles all messages that are an expection to the generic MT ZDO Response.
   1596           *
   1597           * @param  pData - Incoming AF frame.
   1598           *
   1599           * @return  TRUE if handled by this function, FALSE if not
   1600           ***************************************************************************************************/
   1601          uint8 MT_ZdoHandleExceptions( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg )
   1602          {
   1603            uint8 ret = TRUE;
   1604            ZDO_NwkIEEEAddrResp_t *nwkRsp = NULL;
   1605            ZDO_DeviceAnnce_t devAnnce;
   1606            uint8 doDefault = FALSE;
   1607            
   1608            switch ( inMsg->clusterID )
   1609            {
   1610              case NWK_addr_rsp:
   1611              case IEEE_addr_rsp:
   1612                nwkRsp = ZDO_ParseAddrRsp( inMsg );
   1613                MT_ZdoAddrRspCB( nwkRsp, inMsg->clusterID );
   1614                if ( nwkRsp )
   1615                  osal_mem_free( nwkRsp );
   1616                break;
   1617                
   1618              case Device_annce:
   1619                ZDO_ParseDeviceAnnce( inMsg, &devAnnce );
   1620                MT_ZdoEndDevAnnceCB( &devAnnce, inMsg->srcAddr.addr.shortAddr );
   1621                break;
   1622                
   1623              case Simple_Desc_rsp:
   1624                if ( pData->cmd.DataLength > 5 )
   1625                  ret = FALSE;
   1626                else
   1627                  doDefault = TRUE;        
   1628                break;  
   1629                
   1630              default:
   1631                ret = FALSE;
   1632                break;
   1633            }
   1634            
   1635            if ( doDefault )
   1636            {
   1637              ret = FALSE;
   1638              pData->clusterId = MtZdoDef_rsp;
   1639              pData->cmd.DataLength = 2;
   1640            }
   1641          
   1642            return ( ret );
   1643          }
   1644          
   1645          /***************************************************************************************************
   1646           * @fn      MT_ZdoAddrRspCB
   1647           *
   1648           * @brief   Handle IEEE or nwk address response OSAL message from ZDO.
   1649           *
   1650           * @param   pMsg  - Message data
   1651           *
   1652           * @return  void
   1653           */
   1654          void MT_ZdoAddrRspCB( ZDO_NwkIEEEAddrResp_t *pMsg, uint16 clusterID )
   1655          {
   1656            uint8   listLen, len, *pBuf;
   1657          
   1658            /* both ZDO_NwkAddrResp_t and ZDO_IEEEAddrResp_t must be the same */
   1659          
   1660            /* get length, sanity check length */
   1661            listLen = pMsg->numAssocDevs;
   1662            
   1663            /* calculate msg length */
   1664            len = MT_ZDO_ADDR_RSP_LEN + (listLen * sizeof(uint16));
   1665          
   1666            /* get buffer */
   1667            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1668            {
   1669              uint8 id = MT_ZDO_CID_TO_AREQ_ID(clusterID);
   1670              uint8 *pTmp = pBuf;
   1671          
   1672              *pTmp++ = pMsg->status;
   1673          
   1674              osal_cpyExtAddr(pTmp, pMsg->extAddr);
   1675              pTmp += Z_EXTADDR_LEN;
   1676          
   1677              *pTmp++ = LO_UINT16(pMsg->nwkAddr);
   1678              *pTmp++ = HI_UINT16(pMsg->nwkAddr);
   1679          
   1680              *pTmp++ = pMsg->startIndex;
   1681              *pTmp++ = listLen;
   1682          
   1683              MT_Word2Buf(pTmp, pMsg->devList, listLen);
   1684          
   1685              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), id, len, pBuf);
   1686              osal_mem_free(pBuf);
   1687            }
   1688          }
   1689          
   1690          /***************************************************************************************************
   1691           * @fn      MT_ZdoEndDevAnnceCB
   1692           *
   1693           * @brief   Handle end device announce OSAL message from ZDO.
   1694           *
   1695           * @param   pMsg  - Message data
   1696           *
   1697           * @return  void
   1698           */
   1699          void MT_ZdoEndDevAnnceCB( ZDO_DeviceAnnce_t *pMsg, uint16 srcAddr )
   1700          {
   1701            uint8 *pBuf;
   1702          
   1703            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(MT_ZDO_END_DEVICE_ANNCE_IND_LEN)))
   1704            {
   1705              uint8 *pTmp = pBuf;
   1706          
   1707              *pTmp++ = LO_UINT16(srcAddr);
   1708              *pTmp++ = HI_UINT16(srcAddr);
   1709          
   1710              *pTmp++ = LO_UINT16(pMsg->nwkAddr);
   1711              *pTmp++ = HI_UINT16(pMsg->nwkAddr);
   1712          
   1713              osal_cpyExtAddr(pTmp, pMsg->extAddr);
   1714              pTmp += Z_EXTADDR_LEN;
   1715          
   1716              *pTmp = pMsg->capabilities;
   1717          
   1718              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), 
   1719                                                   MT_ZDO_END_DEVICE_ANNCE_IND, 
   1720                                                   MT_ZDO_END_DEVICE_ANNCE_IND_LEN, pBuf);
   1721              osal_mem_free(pBuf);
   1722            }
   1723          }
   1724          
   1725          /***************************************************************************************************
   1726           * @fn      MT_ZdoSrcRtgCB
   1727           *
   1728           * @brief   Handle Src Route from ZDO.
   1729           *
   1730           * @param   pStr  - pointer to the data structure for the src route
   1731           *
   1732           * @return  void* 
   1733           */
   1734          void* MT_ZdoSrcRtgCB( void *pStr )
   1735          {
   1736            uint8 len, *pBuf;
   1737            zdoSrcRtg_t *pSrcRtg = pStr;
   1738            
   1739            // srcAddr (2) + relayCnt (1) + relayList( relaycnt * 2 )
   1740            len = 2 + 1 + pSrcRtg->relayCnt * sizeof(uint16);
   1741          
   1742            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1743            {
   1744              uint8 idx, *pTmp = pBuf;
   1745              uint16 *pRelay;
   1746          
   1747              // Packet payload
   1748              *pTmp++ = LO_UINT16(pSrcRtg->srcAddr);
   1749              *pTmp++ = HI_UINT16(pSrcRtg->srcAddr);
   1750              *pTmp++ = pSrcRtg->relayCnt;
   1751              
   1752              // Relay List
   1753              if( ( pRelay = pSrcRtg->pRelayList ) != NULL )
   1754              {
   1755                for( idx = 0; idx < pSrcRtg->relayCnt; idx ++ )
   1756                {
   1757                  *pTmp++ = LO_UINT16(*pRelay);
   1758                  *pTmp++ = HI_UINT16(*pRelay);
   1759                  pRelay++;
   1760                }
   1761              }
   1762              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1763                                                   MT_ZDO_SRC_RTG_IND, len, pBuf);
   1764              osal_mem_free(pBuf);
   1765            }
   1766            
   1767            return NULL;
   1768          }
   1769          #endif // MT_ZDO_CB_FUNC
   1770          
   1771          /***************************************************************************************************
   1772           * @fn      MT_ZdoSendMsgCB
   1773           *
   1774           * @brief   Proxy the ZDO_SendMsgCBs one message at a time.
   1775           *
   1776           * @param   pMsg  - Message data
   1777           *
   1778           * @return  void
   1779           */
   1780          void MT_ZdoSendMsgCB(zdoIncomingMsg_t *pMsg)
   1781          {
   1782            uint8 len = pMsg->asduLen + 9;
   1783            uint8 *pBuf = (uint8 *)osal_mem_alloc(len);
   1784          
   1785            if (pBuf != NULL)
   1786            {
   1787              uint8 *pTmp = pBuf;
   1788          
   1789              // Assuming exclusive use of network short addresses.
   1790              *pTmp++ = LO_UINT16(pMsg->srcAddr.addr.shortAddr);
   1791              *pTmp++ = HI_UINT16(pMsg->srcAddr.addr.shortAddr);
   1792              *pTmp++ = pMsg->wasBroadcast;
   1793              *pTmp++ = LO_UINT16(pMsg->clusterID);
   1794              *pTmp++ = HI_UINT16(pMsg->clusterID);
   1795              *pTmp++ = pMsg->SecurityUse;
   1796              *pTmp++ = pMsg->TransSeq;
   1797              // Skipping asduLen since it can be deduced from the RPC packet length.
   1798              *pTmp++ = LO_UINT16(pMsg->macDestAddr);
   1799              *pTmp++ = HI_UINT16(pMsg->macDestAddr);
   1800              (void)osal_memcpy(pTmp, pMsg->asdu, pMsg->asduLen);
   1801          
   1802              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1803                                                   MT_ZDO_MSG_CB_INCOMING, len, pBuf);
   1804            }
   1805          }
   1806          
   1807          #endif   /*ZDO Command Processing in MT*/
   1808          /***************************************************************************************************
   1809          ***************************************************************************************************/


 
 
 0 bytes of memory

Errors: none
Warnings: none
